---
import '../styles/fonts.css';
import '../index.css';
import Footer from '../components/layout/Footer.jsx';
import NavbarClient from '../components/layout/NavbarClient.jsx';
import FloatingWhatsApp from '../components/FloatingWhatsApp.jsx';
import ScrollReveal from '../components/ScrollReveal.jsx';
import DeferredAnalytics from '../components/DeferredAnalytics.jsx';
import { getSeoForPath } from '../components/seo/seoConfig.js';

const { title: titleProp, description: descriptionProp, robots: robotsProp } = Astro.props;
const seo = getSeoForPath(Astro.url.pathname);
const title = titleProp || seo.title;
const description = descriptionProp || seo.description;
const robots = robotsProp || 'index,follow,max-image-preview:large';

const normalizeSiteUrl = (value) => {
  if (!value) return '';
  const trimmed = value.trim();
  if (!trimmed) return '';
  const withScheme = /^https?:\/\//i.test(trimmed) ? trimmed : `https://${trimmed}`;
  return withScheme.replace(/\/+$/, '');
};

const canonicalizeSiteUrl = (value) => {
  if (!value) return '';
  try {
    const url = new URL(value);
    if (url.hostname === 'galenesalud.com') {
      url.hostname = 'www.galenesalud.com';
    }
    if (url.hostname === 'www.galenesalud.com') {
      url.protocol = 'https:';
    }
    return url.toString().replace(/\/$/, '');
  } catch {
    return value;
  }
};

const rawSite =
  import.meta.env.VITE_SITE_URL ||
  import.meta.env.PUBLIC_SITE_URL ||
  'https://www.galenesalud.com';
const siteUrl = canonicalizeSiteUrl(normalizeSiteUrl(rawSite));
const canonicalUrl = siteUrl ? `${siteUrl}${Astro.url.pathname}` : '';
const ogImage = siteUrl ? `${siteUrl}/images/hero-lcp-1024.webp` : '/images/hero-lcp-1024.webp';
---
<!doctype html>
<html lang="es-PE">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="robots" content={robots} />
    <meta name="theme-color" content="#064168" />

    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

    <meta property="og:type" content="website" />
    <meta property="og:locale" content="es_PE" />
    <meta property="og:site_name" content="Galene Salud Mental e Integrativa" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1024" />
    <meta property="og:image:height" content="1024" />
    <meta property="og:image:type" content="image/webp" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <title>{title}</title>
    <link
      rel="preload"
      as="image"
      href="/images/hero-lcp-768.webp"
      imagesrcset="/images/hero-lcp-512.webp 512w, /images/hero-lcp-768.webp 768w, /images/hero-lcp-1024.webp 1024w"
      imagesizes="(min-width: 1280px) 664px, (min-width: 1024px) 560px, (min-width: 640px) 512px, 100vw"
    />
  </head>
  <body>
    <div class="font-body text-dark antialiased bg-light page-mesh">
      <ScrollReveal client:load />
      <NavbarClient client:load />
      <main>
        <slot />
      </main>
      <Footer />
      <FloatingWhatsApp />
      <DeferredAnalytics client:idle />
    </div>
  </body>
</html>
